<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>è‚¡ç¥¨å€‰ä½è¨ˆç®—å™¨</title>

  <!-- PWA / iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-title" content="å€‰ä½è¨ˆç®—å™¨">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html {
      background-color: #0f172a;
      height: 100%;
      height: -webkit-fill-available;
    }
    body {
      background-color: #0f172a;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      min-height: 100%;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      /* Prevent pull-to-refresh and bounce */
      overscroll-behavior: none;
      overflow-x: hidden;
      /* Disable zoom on iOS */
      touch-action: pan-x pan-y;
    }
    #root {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    /* Prevent text selection on double-tap */
    * {
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }
    /* Allow text selection in inputs */
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
      /* Prevent zoom on input focus (iOS) */
      font-size: 16px !important;
    }
    /* Prevent double-tap zoom */
    button, a, label {
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    const SUPABASE_URL = 'https://ykdlifojtvejjvccjvcx.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_rFGQ5h2Yq4GnApAZq9cTCQ_B84OgS9O';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const STORAGE_KEY = 'stock-trades-v3';

    function App() {
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [activeTab, setActiveTab] = useState('calculator');
      const [capital, setCapital] = useState('128000');
      const [buyPrice, setBuyPrice] = useState('');
      const [stopLoss, setStopLoss] = useState('');
      const [maxLossPercent, setMaxLossPercent] = useState('0.5');
      const [stopLossType, setStopLossType] = useState('price');
      const [stopLossPercent, setStopLossPercent] = useState('');
      const [targetPrice, setTargetPrice] = useState('');
      const [symbol, setSymbol] = useState('');
      const [trades, setTrades] = useState([]);
      const [editingTrade, setEditingTrade] = useState(null);
      const [trailingStopInput, setTrailingStopInput] = useState('');
      const [closingTrade, setClosingTrade] = useState(null);
      const [exitPriceInput, setExitPriceInput] = useState('');
      const [prices, setPrices] = useState({});
      const [loadingPrices, setLoadingPrices] = useState(false);
      const [priceError, setPriceError] = useState('');
      const [syncStatus, setSyncStatus] = useState('');

      // Auth state listener
      useEffect(() => {
        supabase.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setAuthLoading(false);
        });

        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
      }, []);

      const [authMode, setAuthMode] = useState('login'); // 'login' or 'signup'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [authError, setAuthError] = useState('');
      const [showAuthModal, setShowAuthModal] = useState(false);

      const handleAuth = async (e) => {
        e.preventDefault();
        setAuthError('');

        try {
          if (authMode === 'signup') {
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            setAuthError('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä½ å˜… email ç¢ºèªå¸³æˆ¶ã€‚');
          } else {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            setShowAuthModal(false);
            setEmail('');
            setPassword('');
          }
        } catch (error) {
          setAuthError(error.message);
        }
      };

      const signOut = async () => {
        await supabase.auth.signOut();
        setTrades([]);
      };

      // Load trades from Supabase when user logs in
      const loadTradesFromSupabase = useCallback(async () => {
        if (!user) return;

        setSyncStatus('è¼‰å…¥ä¸­...');
        try {
          const { data, error } = await supabase
            .from('trades')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

          if (error) throw error;

          if (data) {
            const formattedTrades = data.map(t => ({
              id: t.id,
              symbol: t.symbol,
              entryPrice: t.entry_price,
              shares: t.shares,
              initialStopLoss: t.initial_stop_loss,
              currentStopLoss: t.current_stop_loss,
              targetPrice: t.target_price,
              status: t.status,
              riskAmount: t.risk_amount,
              createdAt: t.created_at,
              stopLossHistory: t.stop_loss_history || [],
              exitPrice: t.exit_price,
              pnl: t.pnl,
              closedAt: t.closed_at
            }));
            setTrades(formattedTrades);
          }
          setSyncStatus('');
        } catch (e) {
          console.error('è¼‰å…¥å¤±æ•—:', e);
          setSyncStatus('è¼‰å…¥å¤±æ•—');
        }
      }, [user]);

      useEffect(() => {
        if (user) {
          loadTradesFromSupabase();
        } else if (!authLoading) {
          // Not logged in, load from localStorage
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) setTrades(JSON.parse(saved));
        }
      }, [user, authLoading, loadTradesFromSupabase]);

      const saveTrades = async (newTrades) => {
        setTrades(newTrades);

        if (!user) {
          // Not logged in, save to localStorage
          localStorage.setItem(STORAGE_KEY, JSON.stringify(newTrades));
          return;
        }

        // Logged in, save to Supabase
        setSyncStatus('åŒæ­¥ä¸­...');
      };

      const saveTradeToSupabase = async (trade) => {
        if (!user) return trade;

        const dbTrade = {
          user_id: user.id,
          symbol: trade.symbol,
          entry_price: trade.entryPrice,
          shares: trade.shares,
          initial_stop_loss: trade.initialStopLoss,
          current_stop_loss: trade.currentStopLoss,
          target_price: trade.targetPrice,
          status: trade.status,
          risk_amount: trade.riskAmount,
          stop_loss_history: trade.stopLossHistory,
          exit_price: trade.exitPrice || null,
          pnl: trade.pnl || null,
          closed_at: trade.closedAt || null
        };

        try {
          const { data, error } = await supabase
            .from('trades')
            .insert(dbTrade)
            .select()
            .single();

          if (error) throw error;
          setSyncStatus('å·²åŒæ­¥');
          setTimeout(() => setSyncStatus(''), 2000);
          return { ...trade, id: data.id };
        } catch (e) {
          console.error('å„²å­˜å¤±æ•—:', e);
          setSyncStatus('åŒæ­¥å¤±æ•—');
          return trade;
        }
      };

      const updateTradeInSupabase = async (trade) => {
        if (!user) return;

        try {
          const { error } = await supabase
            .from('trades')
            .update({
              current_stop_loss: trade.currentStopLoss,
              stop_loss_history: trade.stopLossHistory,
              status: trade.status,
              exit_price: trade.exitPrice || null,
              pnl: trade.pnl || null,
              closed_at: trade.closedAt || null
            })
            .eq('id', trade.id)
            .eq('user_id', user.id);

          if (error) throw error;
          setSyncStatus('å·²åŒæ­¥');
          setTimeout(() => setSyncStatus(''), 2000);
        } catch (e) {
          console.error('æ›´æ–°å¤±æ•—:', e);
          setSyncStatus('åŒæ­¥å¤±æ•—');
        }
      };

      const deleteTradeFromSupabase = async (tradeId) => {
        if (!user) return;

        try {
          const { error } = await supabase
            .from('trades')
            .delete()
            .eq('id', tradeId)
            .eq('user_id', user.id);

          if (error) throw error;
          setSyncStatus('å·²åˆªé™¤');
          setTimeout(() => setSyncStatus(''), 2000);
        } catch (e) {
          console.error('åˆªé™¤å¤±æ•—:', e);
          setSyncStatus('åˆªé™¤å¤±æ•—');
        }
      };

      const fetchPrices = async () => {
        const openTrades = trades.filter(t => t.status === 'open');
        if (openTrades.length === 0) return;
        
        setLoadingPrices(true);
        setPriceError('');
        
        try {
          const symbols = openTrades.map(t => t.symbol).join(',');
          const response = await fetch(`/api/quotes?symbols=${symbols}`);
          const data = await response.json();
          
          if (data.error) {
            setPriceError(data.error);
          } else {
            const newPrices = {};
            for (const [sym, quote] of Object.entries(data)) {
              if (quote.c && quote.c > 0) {
                newPrices[sym] = { price: quote.c, change: quote.d, changePercent: quote.dp, updatedAt: new Date().toISOString() };
              }
            }
            setPrices(newPrices);
          }
        } catch (e) {
          setPriceError(`éŒ¯èª¤: ${e.message}`);
        }
        setLoadingPrices(false);
      };

      useEffect(() => {
        if (activeTab === 'trades' && trades.filter(t => t.status === 'open').length > 0) {
          fetchPrices();
          const interval = setInterval(fetchPrices, 60000);
          return () => clearInterval(interval);
        }
      }, [activeTab, trades.length]);

      const calculation = useMemo(() => {
        const capitalNum = parseFloat(capital);
        const buyPriceNum = parseFloat(buyPrice);
        const maxLossPercentNum = parseFloat(maxLossPercent);
        const targetPriceNum = parseFloat(targetPrice);

        let stopLossNum;
        if (stopLossType === 'percent') {
          const slPercent = parseFloat(stopLossPercent);
          if (!slPercent || !buyPriceNum) return null;
          stopLossNum = buyPriceNum * (1 - slPercent / 100);
        } else {
          stopLossNum = parseFloat(stopLoss);
        }

        if (!capitalNum || !buyPriceNum || !stopLossNum || !maxLossPercentNum) return null;
        if (stopLossNum >= buyPriceNum) return { error: 'æ­¢æåƒ¹å¿…é ˆä½æ–¼è²·å…¥åƒ¹' };

        const riskPerShare = buyPriceNum - stopLossNum;
        const stopLossPercentage = (riskPerShare / buyPriceNum) * 100;
        const maxLossAmount = capitalNum * (maxLossPercentNum / 100);
        const totalShares = Math.floor(maxLossAmount / riskPerShare);
        const requiredCapital = totalShares * buyPriceNum;
        const actualRisk = totalShares * riskPerShare;
        const actualRiskPercent = (actualRisk / capitalNum) * 100;
        const capitalUsagePercent = (requiredCapital / capitalNum) * 100;

        let riskRewardRatio = null, potentialProfit = null, targetGainPercent = null;
        if (targetPriceNum && targetPriceNum > buyPriceNum) {
          const profitPerShare = targetPriceNum - buyPriceNum;
          riskRewardRatio = profitPerShare / riskPerShare;
          potentialProfit = totalShares * profitPerShare;
          targetGainPercent = (profitPerShare / buyPriceNum) * 100;
        }

        return { shares: totalShares, riskPerShare, stopLossPercentage, maxLossAmount, requiredCapital, actualRisk, actualRiskPercent, capitalUsagePercent, canAfford: requiredCapital <= capitalNum, actualStopLoss: stopLossNum, riskRewardRatio, potentialProfit, targetGainPercent };
      }, [capital, buyPrice, stopLoss, stopLossType, stopLossPercent, maxLossPercent, targetPrice]);

      const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
      const formatPercent = (num) => `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;

      const addToTrades = async () => {
        if (!calculation || calculation.error || !symbol.trim()) return;
        let newTrade = {
          id: Date.now(), symbol: symbol.toUpperCase(), entryPrice: parseFloat(buyPrice), shares: calculation.shares,
          initialStopLoss: calculation.actualStopLoss, currentStopLoss: calculation.actualStopLoss,
          targetPrice: parseFloat(targetPrice) || null, status: 'open', riskAmount: calculation.actualRisk,
          createdAt: new Date().toISOString(),
          stopLossHistory: [{ price: calculation.actualStopLoss, date: new Date().toISOString(), note: 'åˆå§‹æ­¢æ' }]
        };

        if (user) {
          newTrade = await saveTradeToSupabase(newTrade);
        }

        saveTrades([newTrade, ...trades]);
        setActiveTab('trades');
        setSymbol(''); setBuyPrice(''); setStopLoss(''); setStopLossPercent(''); setTargetPrice('');
      };

      const updateTrailingStop = async (tradeId) => {
        const newStopLoss = parseFloat(trailingStopInput);
        if (!newStopLoss) return;
        let updatedTrade = null;
        const newTrades = trades.map(t => {
          if (t.id === tradeId) {
            const isRiskFree = newStopLoss >= t.entryPrice;
            updatedTrade = { ...t, currentStopLoss: newStopLoss, stopLossHistory: [...t.stopLossHistory, { price: newStopLoss, date: new Date().toISOString(), note: isRiskFree ? 'âœ… Risk Free!' : 'æ¨é«˜æ­¢æ' }] };
            return updatedTrade;
          }
          return t;
        });

        if (user && updatedTrade) {
          await updateTradeInSupabase(updatedTrade);
        }

        saveTrades(newTrades);
        setEditingTrade(null);
        setTrailingStopInput('');
      };

      const closeTrade = async (tradeId) => {
        const exitPrice = parseFloat(exitPriceInput);
        if (!exitPrice) return;
        let closedTrade = null;
        const newTrades = trades.map(t => {
          if (t.id === tradeId) {
            const pnl = (exitPrice - t.entryPrice) * t.shares;
            closedTrade = { ...t, status: 'closed', exitPrice, pnl, closedAt: new Date().toISOString() };
            return closedTrade;
          }
          return t;
        });

        if (user && closedTrade) {
          await updateTradeInSupabase(closedTrade);
        }

        saveTrades(newTrades);
        setClosingTrade(null);
        setExitPriceInput('');
      };

      const deleteTrade = async (tradeId) => {
        if (user) {
          await deleteTradeFromSupabase(tradeId);
        }
        saveTrades(trades.filter(t => t.id !== tradeId));
      };

      const getTradeMetrics = (trade) => {
        const priceData = prices[trade.symbol];
        const currentPrice = priceData?.price;
        const isRiskFree = trade.currentStopLoss >= trade.entryPrice;
        let unrealizedPnL = null, unrealizedPnLPercent = null, currentRisk = null;
        if (currentPrice) {
          unrealizedPnL = (currentPrice - trade.entryPrice) * trade.shares;
          unrealizedPnLPercent = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100;
        }
        currentRisk = isRiskFree ? (trade.currentStopLoss - trade.entryPrice) * trade.shares : (trade.entryPrice - trade.currentStopLoss) * trade.shares;
        return { currentPrice, unrealizedPnL, unrealizedPnLPercent, currentRisk, isRiskFree };
      };

      // Sort trades: open first, then closed at bottom
      const sortedTrades = useMemo(() => {
        return [...trades].sort((a, b) => {
          if (a.status === 'open' && b.status === 'closed') return -1;
          if (a.status === 'closed' && b.status === 'open') return 1;
          // Within same status, sort by date (newest first)
          return new Date(b.createdAt) - new Date(a.createdAt);
        });
      }, [trades]);

      if (authLoading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-white text-lg">è¼‰å…¥ä¸­...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen p-4 pb-8">
          <div className="max-w-2xl mx-auto">
            <div className="text-center mb-4">
              <h1 className="text-xl font-bold text-white mb-0.5">ğŸ“ˆ è‚¡ç¥¨å€‰ä½è¨ˆç®—å™¨</h1>
              <p className="text-slate-400 text-xs">é¢¨éšªç®¡ç† Â· æ­¢æè¿½è¹¤ Â· å¯¦æ™‚å ±åƒ¹</p>
              {/* Auth UI */}
              <div className="mt-2">
                {user ? (
                  <div className="flex items-center justify-center gap-3">
                    <span className="text-slate-400 text-sm">ğŸ‘¤ {user.email}</span>
                    {syncStatus && <span className="text-blue-400 text-xs">{syncStatus}</span>}
                    <button onClick={signOut} className="text-slate-500 hover:text-red-400 text-sm transition">ç™»å‡º</button>
                  </div>
                ) : (
                  <button onClick={() => setShowAuthModal(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                    ğŸ” ç™»å…¥ / è¨»å†Š
                  </button>
                )}
              </div>
            </div>

            {/* Auth Modal */}
            {showAuthModal && !user && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-white font-bold text-lg">{authMode === 'login' ? 'ç™»å…¥' : 'è¨»å†Š'}</h2>
                    <button onClick={() => { setShowAuthModal(false); setAuthError(''); }} className="text-slate-400 hover:text-white">âœ•</button>
                  </div>

                  <form onSubmit={handleAuth} className="space-y-4">
                    <div>
                      <label className="block text-slate-300 text-sm mb-1">Email</label>
                      <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                      <label className="block text-slate-300 text-sm mb-1">å¯†ç¢¼</label>
                      <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required minLength={6} className="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>

                    {authError && (
                      <div className={`text-sm p-2 rounded ${authError.includes('æˆåŠŸ') ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>
                        {authError}
                      </div>
                    )}

                    <button type="submit" className="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition">
                      {authMode === 'login' ? 'ç™»å…¥' : 'è¨»å†Š'}
                    </button>
                  </form>

                  <div className="mt-4 text-center">
                    <button onClick={() => { setAuthMode(authMode === 'login' ? 'signup' : 'login'); setAuthError(''); }} className="text-slate-400 text-sm hover:text-white transition">
                      {authMode === 'login' ? 'æœªæœ‰å¸³æˆ¶ï¼Ÿè¨»å†Š' : 'å·²æœ‰å¸³æˆ¶ï¼Ÿç™»å…¥'}
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="flex gap-2 mb-4">
              <button onClick={() => setActiveTab('calculator')} className={`flex-1 py-3 rounded-xl font-medium transition ${activeTab === 'calculator' ? 'bg-blue-500 text-white' : 'bg-slate-800/50 text-slate-400'}`}>ğŸ§® è¨ˆç®—å™¨</button>
              <button onClick={() => setActiveTab('trades')} className={`flex-1 py-3 rounded-xl font-medium transition relative ${activeTab === 'trades' ? 'bg-blue-500 text-white' : 'bg-slate-800/50 text-slate-400'}`}>
                ğŸ“‹ æŒå€‰
                {trades.filter(t => t.status === 'open').length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{trades.filter(t => t.status === 'open').length}</span>}
              </button>
            </div>

            {activeTab === 'calculator' && (
              <div className="bg-slate-800/50 rounded-2xl p-5 border border-slate-700">
                <div className="space-y-4">
                  <div>
                    <label className="block text-slate-300 text-sm font-medium mb-2">ğŸ·ï¸ è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" value={symbol} onChange={(e) => setSymbol(e.target.value.toUpperCase())} placeholder="AAPL, TSLA, NVDA" className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">ğŸ’° ç¸½æœ¬é‡‘</label>
                      <input type="number" value={capital} onChange={(e) => setCapital(e.target.value)} className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">âš ï¸ æœ€å¤§è™§æ %</label>
                      <input type="number" value={maxLossPercent} onChange={(e) => setMaxLossPercent(e.target.value)} step="0.1" className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">ğŸ¯ è²·å…¥åƒ¹</label>
                      <input type="number" value={buyPrice} onChange={(e) => setBuyPrice(e.target.value)} placeholder="150.00" step="0.01" className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                      <label className="block text-slate-300 text-sm font-medium mb-2">ğŸ¯ ç›®æ¨™åƒ¹</label>
                      <input type="number" value={targetPrice} onChange={(e) => setTargetPrice(e.target.value)} placeholder="é¸å¡«" step="0.01" className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                  </div>
                  <div>
                    <label className="block text-slate-300 text-sm font-medium mb-2">ğŸ›‘ æ­¢æ</label>
                    <div className="flex gap-2 mb-2">
                      <button onClick={() => setStopLossType('price')} className={`flex-1 py-2 rounded-lg text-sm font-medium ${stopLossType === 'price' ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>åƒ¹æ ¼</button>
                      <button onClick={() => setStopLossType('percent')} className={`flex-1 py-2 rounded-lg text-sm font-medium ${stopLossType === 'percent' ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>ç™¾åˆ†æ¯”</button>
                    </div>
                    {stopLossType === 'price' ? (
                      <input type="number" value={stopLoss} onChange={(e) => setStopLoss(e.target.value)} placeholder="æ­¢æåƒ¹" step="0.01" className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    ) : (
                      <div className="relative">
                        <input type="number" value={stopLossPercent} onChange={(e) => setStopLossPercent(e.target.value)} placeholder="5" step="0.1" className="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 pr-10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">%</span>
                      </div>
                    )}
                    {stopLossType === 'percent' && buyPrice && stopLossPercent && <p className="text-slate-400 text-xs mt-1">= {formatCurrency(parseFloat(buyPrice) * (1 - parseFloat(stopLossPercent) / 100))}</p>}
                  </div>
                </div>

                {calculation && (
                  <div className="mt-5 pt-5 border-t border-slate-700">
                    {calculation.error ? (
                      <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-300 text-center">âŒ {calculation.error}</div>
                    ) : (
                      <div className="space-y-4">
                        <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-500/30 rounded-xl p-4 text-center">
                          <p className="text-green-300 text-sm">å»ºè­°è²·å…¥</p>
                          <p className="text-4xl font-bold text-white">{calculation.shares} è‚¡</p>
                          <p className="text-slate-400 text-sm mt-1">éœ€ {formatCurrency(calculation.requiredCapital)} ({calculation.capitalUsagePercent.toFixed(1)}%)</p>
                        </div>
                        {calculation.riskRewardRatio && (
                          <div className={`rounded-xl p-3 text-center ${calculation.riskRewardRatio >= 2 ? 'bg-emerald-500/20 border border-emerald-500/30' : calculation.riskRewardRatio >= 1 ? 'bg-yellow-500/20 border border-yellow-500/30' : 'bg-red-500/20 border border-red-500/30'}`}>
                            <p className="text-slate-300 text-sm">R:R</p>
                            <p className="text-2xl font-bold text-white">1 : {calculation.riskRewardRatio.toFixed(2)}</p>
                          </div>
                        )}
                        <div className="grid grid-cols-2 gap-3">
                          <div className="bg-slate-700/30 rounded-xl p-3 text-center">
                            <p className="text-slate-400 text-xs">æ­¢æåƒ¹</p>
                            <p className="text-white font-semibold">{formatCurrency(calculation.actualStopLoss)}</p>
                            <p className="text-red-400 text-xs">-{calculation.stopLossPercentage.toFixed(1)}%</p>
                          </div>
                          <div className="bg-slate-700/30 rounded-xl p-3 text-center">
                            <p className="text-slate-400 text-xs">é¢¨éšªé‡‘é¡</p>
                            <p className="text-white font-semibold">{formatCurrency(calculation.actualRisk)}</p>
                            <p className="text-slate-400 text-xs">{calculation.actualRiskPercent.toFixed(2)}% æœ¬é‡‘</p>
                          </div>
                        </div>
                        {calculation.potentialProfit && (
                          <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-3 text-center">
                            <p className="text-emerald-300 text-xs">æ½›åœ¨ç›ˆåˆ©</p>
                            <p className="text-white font-bold text-lg">{formatCurrency(calculation.potentialProfit)}</p>
                            <p className="text-emerald-400 text-xs">+{calculation.targetGainPercent.toFixed(1)}%</p>
                          </div>
                        )}
                        <button onClick={addToTrades} disabled={!symbol.trim()} className={`w-full py-3 rounded-xl font-medium transition ${symbol.trim() ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>ğŸ“‹ åŠ å…¥æŒå€‰</button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {activeTab === 'trades' && (
              <div className="space-y-4">
                {trades.filter(t => t.status === 'open').length > 0 && (
                  <div className="space-y-2">
                    <button onClick={fetchPrices} disabled={loadingPrices} className="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-2 text-slate-300 text-sm hover:bg-slate-700/50 transition">
                      {loadingPrices ? 'â³ æ›´æ–°ä¸­...' : 'ğŸ”„ æ›´æ–°å ±åƒ¹'}
                    </button>
                    {priceError && <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-3 text-red-300 text-sm">âŒ {priceError}</div>}
                  </div>
                )}

                {trades.length === 0 ? (
                  <div className="bg-slate-800/50 rounded-2xl p-8 text-center border border-slate-700">
                    <p className="text-slate-400">æš«ç„¡æŒå€‰è¨˜éŒ„</p>
                    <p className="text-slate-500 text-sm mt-1">å–ºè¨ˆç®—å™¨åŠ å…¥æ–°äº¤æ˜“</p>
                  </div>
                ) : (
                  <>
                    <div className="grid grid-cols-3 gap-2">
                      <div className="bg-slate-800/50 rounded-xl p-3 text-center border border-slate-700">
                        <p className="text-slate-400 text-xs">æŒå€‰</p>
                        <p className="text-white font-bold text-lg">{trades.filter(t => t.status === 'open').length}</p>
                      </div>
                      <div className="bg-emerald-500/10 rounded-xl p-3 text-center border border-emerald-500/30">
                        <p className="text-emerald-300 text-xs">Risk Free</p>
                        <p className="text-white font-bold text-lg">{trades.filter(t => t.status === 'open' && t.currentStopLoss >= t.entryPrice).length}</p>
                      </div>
                      <div className="bg-slate-800/50 rounded-xl p-3 text-center border border-slate-700">
                        <p className="text-slate-400 text-xs">å·²å¹³å€‰</p>
                        <p className="text-white font-bold text-lg">{trades.filter(t => t.status === 'closed').length}</p>
                      </div>
                    </div>

                    {sortedTrades.map((trade) => {
                      const metrics = trade.status === 'open' ? getTradeMetrics(trade) : null;
                      const isEditing = editingTrade === trade.id;
                      const isClosing = closingTrade === trade.id;
                      
                      return (
                        <div key={trade.id} className={`bg-slate-800/50 rounded-2xl p-4 border ${trade.status === 'closed' ? (trade.pnl >= 0 ? 'border-green-500/50' : 'border-red-500/50') : metrics?.isRiskFree ? 'border-emerald-500/50' : 'border-slate-700'}`}>
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <span className="text-white font-bold text-xl">{trade.symbol}</span>
                              {trade.status === 'open' && metrics?.isRiskFree && <span className="bg-emerald-500/20 text-emerald-300 text-xs px-2 py-1 rounded-full">âœ… Risk Free</span>}
                              {trade.status === 'closed' && <span className={`text-xs px-2 py-1 rounded-full ${trade.pnl >= 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>å·²å¹³å€‰</span>}
                            </div>
                            <button onClick={() => deleteTrade(trade.id)} className="text-slate-500 hover:text-red-400 text-sm">ğŸ—‘ï¸</button>
                          </div>

                          {trade.status === 'open' && metrics?.currentPrice && (
                            <div className={`rounded-xl p-3 mb-3 ${metrics.unrealizedPnL >= 0 ? 'bg-green-500/10' : 'bg-red-500/10'}`}>
                              <div className="flex items-center justify-between">
                                <div>
                                  <p className="text-slate-400 text-xs">ç¾åƒ¹</p>
                                  <p className="text-white font-bold text-2xl">{formatCurrency(metrics.currentPrice)}</p>
                                </div>
                                <div className="text-right">
                                  <p className="text-slate-400 text-xs">æœªå¯¦ç¾ç›ˆè™§</p>
                                  <p className={`font-bold text-xl ${metrics.unrealizedPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatCurrency(metrics.unrealizedPnL)}</p>
                                  <p className={`text-sm ${metrics.unrealizedPnLPercent >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatPercent(metrics.unrealizedPnLPercent)}</p>
                                </div>
                              </div>
                            </div>
                          )}

                          <div className="grid grid-cols-3 gap-2 mb-3 text-center">
                            <div className="bg-slate-700/30 rounded-lg p-2">
                              <p className="text-slate-400 text-xs">å…¥å ´åƒ¹</p>
                              <p className="text-white font-medium">{formatCurrency(trade.entryPrice)}</p>
                            </div>
                            <div className="bg-slate-700/30 rounded-lg p-2">
                              <p className="text-slate-400 text-xs">è‚¡æ•¸</p>
                              <p className="text-white font-medium">{trade.shares}</p>
                            </div>
                            <div className="bg-slate-700/30 rounded-lg p-2">
                              <p className="text-slate-400 text-xs">åˆå§‹æ­¢æ</p>
                              <p className="text-white font-medium">{formatCurrency(trade.initialStopLoss)}</p>
                            </div>
                          </div>

                          {trade.status === 'open' && (
                            <div className={`rounded-xl p-3 mb-3 ${metrics?.isRiskFree ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-slate-700/30'}`}>
                              <div className="flex items-center justify-between">
                                <div>
                                  <p className="text-slate-400 text-xs">ç¾æ™‚æ­¢æ</p>
                                  <p className="text-white font-bold text-lg">{formatCurrency(trade.currentStopLoss)}</p>
                                </div>
                                <div className="text-right">
                                  <p className="text-slate-400 text-xs">{metrics?.isRiskFree ? 'ä¿è­‰åˆ©æ½¤' : 'é¢¨éšªé‡‘é¡'}</p>
                                  <p className={`font-bold ${metrics?.isRiskFree ? 'text-emerald-400' : 'text-red-400'}`}>{metrics?.isRiskFree ? '+' : '-'}{formatCurrency(Math.abs(metrics?.currentRisk || 0))}</p>
                                </div>
                              </div>
                              {!metrics?.isRiskFree && (
                                <div className="mt-2">
                                  <div className="flex justify-between text-xs text-slate-400 mb-1">
                                    <span>â†’ Risk Free</span>
                                    <span>{formatCurrency(trade.entryPrice - trade.currentStopLoss)}</span>
                                  </div>
                                  <div className="w-full bg-slate-600 rounded-full h-1.5">
                                    <div className="bg-gradient-to-r from-yellow-500 to-emerald-500 h-1.5 rounded-full" style={{ width: `${Math.max(0, Math.min(100, ((trade.currentStopLoss - trade.initialStopLoss) / (trade.entryPrice - trade.initialStopLoss)) * 100))}%` }} />
                                  </div>
                                </div>
                              )}
                            </div>
                          )}

                          {trade.status === 'closed' && (
                            <div className={`rounded-xl p-3 mb-3 ${trade.pnl >= 0 ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                              <div className="flex items-center justify-between">
                                <div>
                                  <p className="text-slate-400 text-xs">å¹³å€‰åƒ¹</p>
                                  <p className="text-white font-bold">{formatCurrency(trade.exitPrice)}</p>
                                </div>
                                <div className="text-right">
                                  <p className="text-slate-400 text-xs">ç›ˆè™§</p>
                                  <p className={`font-bold text-xl ${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>{trade.pnl >= 0 ? '+' : ''}{formatCurrency(trade.pnl)}</p>
                                </div>
                              </div>
                            </div>
                          )}

                          {trade.status === 'open' && (
                            <div className="space-y-2">
                              {isEditing ? (
                                <div className="flex gap-2">
                                  <input type="number" value={trailingStopInput} onChange={(e) => setTrailingStopInput(e.target.value)} placeholder="æ–°æ­¢æåƒ¹" step="0.01" className="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                  <button onClick={() => updateTrailingStop(trade.id)} className="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm">âœ“</button>
                                  <button onClick={() => { setEditingTrade(null); setTrailingStopInput(''); }} className="bg-slate-700 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>
                                </div>
                              ) : isClosing ? (
                                <div className="flex gap-2">
                                  <input type="number" value={exitPriceInput} onChange={(e) => setExitPriceInput(e.target.value)} placeholder="å¹³å€‰åƒ¹" step="0.01" className="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                  <button onClick={() => closeTrade(trade.id)} className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm">âœ“</button>
                                  <button onClick={() => { setClosingTrade(null); setExitPriceInput(''); }} className="bg-slate-700 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>
                                </div>
                              ) : (
                                <div className="flex gap-2">
                                  <button onClick={() => { setEditingTrade(trade.id); setTrailingStopInput(trade.currentStopLoss.toString()); }} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm transition">ğŸ“ˆ æ›´æ–°æ­¢æ</button>
                                  <button onClick={() => setClosingTrade(trade.id)} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm transition">ğŸ å¹³å€‰</button>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </>
                )}
              </div>
            )}

            <div className="mt-4 text-center text-slate-500 text-xs">å ±åƒ¹ä¾†æºï¼šFinnhub Â· æ¯ 60 ç§’è‡ªå‹•æ›´æ–°</div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
